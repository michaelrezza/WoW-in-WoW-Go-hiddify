name: Auto Update WARP IPv6

on:
  schedule:
    - cron: '0 * * * *'   # Runs automatically every hour
  workflow_dispatch:        # Allows manual execution

permissions:
  contents: write  # Ensure GitHub Actions has write access to commit changes

jobs:
  update_warp_ipv6:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools curl jq fping

      - name: Download and Install WARP-GO
        run: |
          wget -O install-warp.sh https://raw.githubusercontent.com/Ptechgithub/warp/main/endip/install.sh
          chmod +x install-warp.sh
          sudo ./install-warp.sh

      - name: Ensure Scripts Are Downloaded & Executable
        run: |
          mkdir -p ./scripts
          wget -O ./scripts/warp-go.sh https://raw.githubusercontent.com/michaelrezza/WoW-in-WoW-Go-hiddify/main/scripts/warp-go.sh
          wget -O ./scripts/ipv6-scan.sh https://raw.githubusercontent.com/michaelrezza/WoW-in-WoW-Go-hiddify/main/scripts/ipv6-scan.sh
          wget -O ./scripts/update-ip-port.py https://raw.githubusercontent.com/michaelrezza/WoW-in-WoW-Go-hiddify/main/scripts/update-ip-port.py
          chmod +x ./scripts/*.sh

      - name: Run WARP Setup
        run: |
          for i in {1..3}; do
            echo "2" | bash ./scripts/warp-go.sh && break
            sleep 5
          done

      - name: Run IPv6 Scanner
        run: |
          for i in {1..3}; do
            bash ./scripts/ipv6-scan.sh && break
            sleep 5
          done

      - name: Generate New IPv6 & Update Config
        run: |
          NEW_IPV6=$(curl -s https://api64.ipify.org)  # Fetch new IPv6
          echo "üîÑ New IPv6: $NEW_IPV6"
          python3 ./scripts/update-ip-port.py --ipv6 "$NEW_IPV6"

      - name: Force Git to Track hiddify-config.json
        run: |
          git rm --cached hiddify-config.json || echo "‚úÖ hiddify-config.json was not ignored."
          git add hiddify-config.json

      - name: Debug Git Status
        run: |
          git status
          ls -lah hiddify-config.json

      - name: Force Add and Commit Changes
        run: |
          git add -A
          git commit -m "üîÑ Auto-update Hiddify config with new WARP IPv6: $NEW_IPV6" || echo "‚ö†Ô∏è No changes to commit."
          git push || echo "‚ö†Ô∏è Failed to push changes."

      - name: Auto-Restart on Failure
        if: failure()
        run: |
          gh workflow run update-warp.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
