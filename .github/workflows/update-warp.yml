name: WARP-in-WARP Auto Update

on:
  schedule:
    - cron: "0 * * * *"  # Runs automatically every hour
  workflow_dispatch:  # Allows manual execution

jobs:
  update_warp_ipv6:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools curl jq fping cloudflare-warp  # Include cloudflare-warp here
          # Install warp-cli using the method below (more robust)

      - name: Get latest warp-cli version
        id: get_warp_cli_version
        run: |
          VERSION=$(curl -s https://api.github.com/repos/cloudflare/warp-cli/releases/latest | jq -r '.tag_name' | sed 's/v//')
          echo "::set-output name=version::$VERSION"

      - name: Install warp-cli
        run: |
          wget https://github.com/cloudflare/warp-cli/releases/download/${{ steps.get_warp_cli_version.outputs.version }}/warp-cli-linux-amd64
          chmod +x warp-cli-linux-amd64
          sudo mv warp-cli-linux-amd64 /usr/local/bin/warp-cli

      - name: Download and Install WARP-GO (Modified)
        run: |
          wget -O install-warp.sh https://raw.githubusercontent.com/Ptechgithub/warp/main/endip/install.sh
          chmod +x install-warp.sh
          sudo ./install-warp.sh

      - name: Ensure Scripts Are Downloaded & Executable
        run: |
          mkdir -p ./scripts
          wget -O ./scripts/warp-go.sh https://raw.githubusercontent.com/michaelrezza/WoW-in-WoW-Go-hiddify/main/scripts/warp-go.sh
          wget -O ./scripts/ipv6-scan.sh https://raw.githubusercontent.com/michaelrezza/WoW-in-WoW-Go-hiddify/main/scripts/ipv6-scan.sh
          wget -O ./scripts/update-ip-port.py https://raw.githubusercontent.com/michaelrezza/WoW-in-WoW-Go-hiddify/main/scripts/update-ip-port.py
          chmod +x ./scripts/*.sh

      - name: Download cloudflared  (Use apt if possible)
        run: |
          # cloudflare-warp package should install cloudflared as a dependency.
          # If not, try installing cloudflared this way:
          # wget https://github.com/cloudflare/cloudflared/releases/download/2025.2.0/cloudflared-linux-amd64.deb  # Update Version!
          # sudo dpkg -i cloudflared-linux-amd64.deb
          # sudo apt-get install -f
          # or:
          sudo apt-get install -y cloudflared # If it's in the repo
          cloudflared version # Check if it's installed

      - name: Run WARP Setup & IPv6 Scan
        run: |
          for i in {1..3}; do
            echo "2" | bash ./scripts/warp-go.sh && break
            sleep 5
          done

      - name: Update IPv6 & Port in Config
        run: |
          python3 ./scripts/update-ip-port.py

      - name: Ensure Correct Permissions for hiddify-config.json
        run: |
          chmod 644 hiddify-config.json

      - name: Set up Git identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"

      - name: Commit and Push Changes
        run: |
          git add hiddify-config.json || echo "‚ö†Ô∏è No changes."
          git diff --cached --quiet || git commit -m "üîÑ Auto-update WARP-in-WARP IPv6 & Port"
          git push || echo "‚ö†Ô∏è Push failed."

      - name: Auto-Restart on Failure
        if: failure()
        run: |
          gh workflow run update-warp.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
